---
title: "CoxPH"
author: "Amy Watt"
date: "4/12/2019"
output: 
  html_document: 
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
aids <- read.csv("AIDSdata.csv")
library(tidyverse)
library(tidylog)
library(broom)
library(ggplot2)
library(survival)
library(survminer)
```

```{r, echo=FALSE}
#Changing data from numerical to text
aids$censor_text <- NA
aids$censor_d_text <- NA
aids$txgrp_text <- NA
aids$strat2_text <- NA
aids$sex_text <- NA
aids$raceth_text <- NA
aids$ivdrug_text <- NA
aids$hemophil_text <- NA

#Adding a new column in dataframe for combined sex/raceth demographics.

aids$demo <- NA
aids$demo_text <- NA

#Adding a new column to split cd4 into factors
aids <- aids %>% 
  mutate(cd4f = ifelse(cd4 <= 50, "under50", 
                             ifelse(cd4 <=100, "50-100",
                                    ifelse(cd4 <= 150, "100-150",
                                           ifelse(cd4 <=200, "150-200", "over200"))))) %>%
  mutate(cd4f = factor(cd4f,
                       levels = c("under50", "50-100", "100-150","150-200", "over200")))
```

```{r, echo=FALSE}
for (elt in 1:length(aids$id)) {
  s = toString(aids$sex[elt])
  r = toString(aids$raceth[elt])
  aids$demo[elt] <- as.numeric(paste (s, r, sep=''))
  
  if (aids$censor[elt] == 1) {
    aids$censor_text[elt] <- 'AIDS/death'
  } else {
    aids$censor_text[elt] <- 'Otherwise'
  }
  
  if (aids$censor_d[elt] == 1) {
    aids$censor_d_text[elt] <- 'Death'
  } else {
    aids$censor_d_text[elt] <- 'Otherwise'
  }
  
  if (aids$txgrp[elt] == 1) {
    aids$txgrp_text[elt] <- 'Placebo'
  } else {
    aids$txgrp_text[elt] <- 'IDV'
  }
  
  if (aids$strat2[elt] == 1) {
    aids$strat2_text[elt] <- 'CD4 <= 50'
  } else {
    aids$strat2_text[elt] <- 'CD4 > 50'
  }
  
  if (aids$sex[elt] == 1) {
    aids$sex_text[elt] <- 'Male'
  } else {
    aids$sex_text[elt] <- 'Female'
  }
  
  if (aids$raceth[elt] == 1) {
    aids$raceth_text[elt] <- 'White Non-Hispanic'
  } else if (aids$raceth[elt] == 2) {
    aids$raceth_text[elt] <- 'Black Non-Hispanic'
  } else if (aids$raceth[elt] == 3) {
    aids$raceth_text[elt] <- 'Hispanic'
  } else if (aids$raceth[elt] == 4) {
    aids$raceth_text[elt] <- 'Asian/Pacific Islander'
  } else if (aids$raceth[elt] == 5) {
    aids$raceth_text[elt] <- 'American Indian/Alaskan Native'
  } else if (aids$raceth[elt] == 6) {
    aids$raceth_text[elt] <- 'Other/Unknown'
  }
  
  if (aids$ivdrug[elt] == 1) {
    aids$ivdrug_text[elt] <- 'Never'
  } else if (aids$ivdrug[elt] == 2) {
    aids$ivdrug_text[elt] <- 'Currently'
  } else if (aids$ivdrug[elt] == 3) {
    aids$ivdrug_text[elt] <- 'Previously'
  }
  
  if (aids$hemophil[elt] == 1) {
    aids$hemophil_text[elt] <- 'Yes'
  } else if (aids$hemophil[elt] == 0) {
    aids$hemophil_text[elt] <- 'No'
  }
  
  aids$demo_text[elt] <- (paste (aids$sex_text[elt], aids$raceth_text[elt], sep=', '))
}
```  

Investigation of the proportional hazards assumption (what does the R function cox.zph do?).

Investigating the proportional hazards assumption relates to the survival analysis because the Cox PH model technical conditions include the proportional hazards assumption. If the assumption does not hold, the model could be inaccurate. The resources I plan to use to investigate the assumption include R documentation of the cox.zph function, and understanding what the function is doing to calculate the p-values of the covariates. 


```{r}
KM <- survfit(Surv(time, censor)~1, data=aids)
ggsurvplot(KM, conf.int=TRUE, censor=F) + ggtitle("Overall Survival Curve")
ggsurvplot(KM, fun="cumhaz") + ggtitle("Cumulative Hazard Curve")
```
```{r}
KM <- survfit(Surv(time, censor)~txgrp_text, type="kaplan-meier", conf.type="log", data=aids)
ggsurvplot(KM, conf.int=TRUE, censor=F) + ggtitle("Survival Curve by Treatment")
ggsurvplot(KM, fun="cumhaz") + ggtitle("Cumulative Hazard Curve by Treatment")
```

```{r}
covariates <- c("txgrp", "sex",  "raceth", "ivdrug", "hemophil", "karnof", "cd4", "priorzdv", "age")
univ_formulas <- sapply(covariates,
                        function(x) as.formula(paste('Surv(time, censor)~', x)))
univ_models <- lapply( univ_formulas, function(x){coxph(x, data = aids)})
# Extract data 
univ_results <- lapply(univ_models,
                       function(x){ 
                          x <- summary(x)
                          p.value<-signif(x$wald["pvalue"], digits=2)
                          wald.test<-signif(x$wald["test"], digits=2)
                          beta<-signif(x$coef[1], digits=2);#coeficient beta
                          HR <-signif(x$coef[2], digits=2);#exp(beta)
                          HR.confint.lower <- signif(x$conf.int[,"lower .95"], 2)
                          HR.confint.upper <- signif(x$conf.int[,"upper .95"],2)
                          HR <- paste0(HR, " (", 
                                       HR.confint.lower, "-", HR.confint.upper, ")")
                          res<-c(beta, HR, wald.test, p.value)
                          names(res)<-c("beta", "HR (95% CI for HR)", "wald.test", 
                                        "p.value")
                          return(res)
                          #return(exp(cbind(coef(x),confint(x))))
                         })
res <- t(as.data.frame(univ_results, check.names = FALSE))
as.data.frame(res)
```
The individual covariates txgrp, karnof, and cd4 have significant correlation coefficients. The order of covariates in order of most to least significant is karnof, cd4, txgrp, age, ivdrug, prior zdv, sex, hemophil and raceth. A multivariate model will be fit with the three significant covariates. 
```{r}
cox <- coxph(Surv(time,censor) ~ txgrp, data = aids)
cox %>% tidy()
pchisq((-2*cox$loglik[1])-(-2*cox$loglik[2]), d=1, lower.tail = FALSE)
```
The LRT for adding in txgrp as a variable results in a p-value of 0.002, so it is included in the model. 

```{r}
cox1 <- coxph(Surv(time,censor) ~ txgrp + karnof, data = aids)
cox1 %>% tidy()
pchisq((-2*cox$loglik[2])-(-2*cox1$loglik[2]), d=1, lower.tail = FALSE)
```
The LRT for adding in karnof as a variable results in a p-value of 1.320752e-08, so it is included in the model.

```{r}
cox2 <- coxph(Surv(time,censor) ~ txgrp + karnof + cd4, data = aids)
cox2 %>% tidy()
pchisq((-2*cox1$loglik[2])-(-2*cox2$loglik[2]), d=1, lower.tail = FALSE)
```
The LRT for adding in cd4 as a variable results in a p-value of 7.403133e-09, so it is included in the model. 

```{r}
cox3 <- coxph(Surv(time,censor) ~ txgrp + karnof + cd4 + age, data = aids)
cox3 %>% tidy()
pchisq((-2*cox2$loglik[2])-(-2*cox3$loglik[2]), d=1, lower.tail = FALSE)
```
The LRT for adding in age as a variable results in a p-value of .13, so it is not included in the model. Cox2 is the best model using forward selection. Next, I will create a model where cd4 is split into factors to see if it shoud be a categorical or continuous variable. 

```{r}
cox4 <- coxph(Surv(time,censor) ~ txgrp + karnof + cd4f, data = aids)
cox4 %>% tidy()
pchisq((-2*cox1$loglik[2])-(-2*cox4$loglik[2]), d=6, lower.tail = FALSE)
```
The p-value of 2.559148e-06 shows that the cd4 categories should be included in the model. Now, I will consider interaction between cd4f and the other two variables. 

```{r}
-1.89993881--2.39426985
-2.39426985--2.93830829
-2.93830829--0.31005778
```
The log(HR) will be linear in cd4 if it should be linear. Thus, $e^{b_2}/e^{b_1}=e^{b_3}/e^{b_2}=e^{b_4}/e^{b_3}$, so $b_2-b_1=b_3-b_2=b_4-b_3$. because there are constant 50 cd4 gaps between the groups. The relationship holds for the upper 3 cd4 factors, but the value from moving from the lowest to the next lowest cd4 group is -2.628251 as compared to around 0.5, so cd4 should be kept as factors. Next, I will create models with interaction. 

```{r}
cox5 <- coxph(Surv(time,censor) ~ txgrp + karnof*cd4f, data = aids)
cox5 %>% tidy()
pchisq((-2*cox4$loglik[2])-(-2*cox5$loglik[2]), d=6, lower.tail = FALSE)
```
The p-value of 0.2164783 indicates that interaction between karnof and cd4f is not necessary in the model. 

```{r}
cox6 <- coxph(Surv(time,censor) ~ txgrp*cd4f + karnof + cd4f, data = aids)
cox6 %>% tidy()
pchisq((-2*cox4$loglik[2])-(-2*cox6$loglik[2]), d=6, lower.tail = FALSE)
```
The p-value of 0.5398977 indicates that interaction between txgrp and cd4 is not needed in the model. 
```{r}
ggsurvplot(survfit(cox2), data=aids, ggtheme = theme_minimal()) + ggtitle ("Survival Curve")
ggsurvplot(survfit(cox2), data=aids, ggtheme = theme_minimal(), fun="cumhaz") + ggtitle("Cumulative Hazard Curve")
```
---
title: "CoxPH"
author: "Amy Watt"
date: "4/12/2019"
output:
  html_document:
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
aids <- read.csv("AIDSdata.csv")
library(tidyverse)
library(tidylog)
library(broom)
library(ggplot2)
library(survival)
library(survminer)
library(grid)
```

```{r, echo=FALSE}
#Changing data from numerical to text
aids$censor_text <- NA
aids$censor_d_text <- NA
aids$txgrp_text <- NA
aids$strat2_text <- NA
aids$sex_text <- NA
aids$raceth_text <- NA
aids$ivdrug_text <- NA
aids$hemophil_text <- NA

#Adding a new column in dataframe for combined sex/raceth demographics.

aids$demo <- NA
aids$demo_text <- NA

#Adding a new column to split cd4 into factors
aids <- aids %>% 
  mutate(cd4f = ifelse(cd4 <= 50, "under50", 
                             ifelse(cd4 <=100, "50-100",
                                    ifelse(cd4 <= 150, "100-150",
                                           ifelse(cd4 <=200, "150-200", "over200"))))) %>%
  mutate(cd4f = factor(cd4f,
                       levels = c("under50", "50-100", "100-150","150-200", "over200")))
```

```{r, echo=FALSE}
for (elt in 1:length(aids$id)) {
  s = toString(aids$sex[elt])
  r = toString(aids$raceth[elt])
  aids$demo[elt] <- as.numeric(paste (s, r, sep=''))
  
  if (aids$censor[elt] == 1) {
    aids$censor_text[elt] <- 'AIDS/death'
  } else {
    aids$censor_text[elt] <- 'Otherwise'
  }
  
  if (aids$censor_d[elt] == 1) {
    aids$censor_d_text[elt] <- 'Death'
  } else {
    aids$censor_d_text[elt] <- 'Otherwise'
  }
  
  if (aids$txgrp[elt] == 1) {
    aids$txgrp_text[elt] <- 'Placebo'
  } else {
    aids$txgrp_text[elt] <- 'IDV'
  }
  
  if (aids$strat2[elt] == 1) {
    aids$strat2_text[elt] <- 'CD4 <= 50'
  } else {
    aids$strat2_text[elt] <- 'CD4 > 50'
  }
  
  if (aids$sex[elt] == 1) {
    aids$sex_text[elt] <- 'Male'
  } else {
    aids$sex_text[elt] <- 'Female'
  }
  
  if (aids$raceth[elt] == 1) {
    aids$raceth_text[elt] <- 'White Non-Hispanic'
  } else if (aids$raceth[elt] == 2) {
    aids$raceth_text[elt] <- 'Black Non-Hispanic'
  } else if (aids$raceth[elt] == 3) {
    aids$raceth_text[elt] <- 'Hispanic'
  } else if (aids$raceth[elt] == 4) {
    aids$raceth_text[elt] <- 'Asian/Pacific Islander'
  } else if (aids$raceth[elt] == 5) {
    aids$raceth_text[elt] <- 'American Indian/Alaskan Native'
  } else if (aids$raceth[elt] == 6) {
    aids$raceth_text[elt] <- 'Other/Unknown'
  }
  
  if (aids$ivdrug[elt] == 1) {
    aids$ivdrug_text[elt] <- 'Never'
  } else if (aids$ivdrug[elt] == 2) {
    aids$ivdrug_text[elt] <- 'Currently'
  } else if (aids$ivdrug[elt] == 3) {
    aids$ivdrug_text[elt] <- 'Previously'
  }
  
  if (aids$hemophil[elt] == 1) {
    aids$hemophil_text[elt] <- 'Yes'
  } else if (aids$hemophil[elt] == 0) {
    aids$hemophil_text[elt] <- 'No'
  }
  
  aids$demo_text[elt] <- (paste (aids$sex_text[elt], aids$raceth_text[elt], sep=', '))
}
```  

```{r, echo = FALSE}
plot.haz <- function(KM.obj,plot="TRUE") {
ti <- summary(KM.obj)$time
di <- summary(KM.obj)$n.event
ni <- summary(KM.obj)$n.risk
#Est Hazard Function
est.haz <- 1:(length(ti))
for (i in 1:(length(ti)-1))
 est.haz[i] <- di[i]/(ni[i]*(ti[i+1]-ti[i]))
est.haz[length(ti)] <- est.haz[length(ti)-1]

if (plot=="TRUE") {
  plot(ti,est.haz,type="s",xlab="Time",
ylab="Hazard Rate",
main=expression(paste(hat(h),(t)[KM])))
}
} 
```

The Cox Proportional Hazards model describes the relationship between survival of an individual based on one or more explanatory variables (covariates). Thus, it can help estimate the effectiveness of treatment on survival, and can provide an estimate of the hazard function (the liklihood of the event occuring at any given point in time) based on the covariates. I will select explanatory variables from the AIDS study to build a Cox model to predict survival information related to the significant explanatory variables, as well as to construct an estimates of the hazard function to predict the liklihood of an individual experiencing AIDS diagnosis or death. The Cox model relies on the assumption that there are proportional hazards (the ratio of hazards for any two individuals is constant over time). This is because the Cox model is built on the following: $h_i(t) = h_0(t)e^{\beta x_i}$. Then, the hazard ratio for individuals $i$ and $j$ is $\frac{h_0(t)e^{\beta x_i}}{h_0(t)e^{\beta x_j}}=e^{\beta(x_i-x_j)}$, so there are proportional hazards for any two individuals, independent of time. Additionally, $e^{\beta_k}$ can be interpreted as the hazard ratio associated with a one unit increase in covariate $k$. Because the Cox model is build upon a proportional hazards assumption, it is important to investigate and test whether there are proportional hazards in a proposed model. 

Under the proportional hazards assumption, the $\beta$ coefficients are determined with maximum liklihood estimation. $L(\beta)=\prod_{i=1}^{n} {(\frac{e^{\beta x_i}}{\sum_{k:t_k>t_i}e^{\beta x_k}})}^{\delta_i} \text{ where } \delta_i \text{ is an indicator for events}$. $b=\hat{\beta}$ is determined by taking the log-liklihood and setting partial derivatives with respect to $\beta$ equal to 0. When proportional hazards are violated, the hazard ratio is dependent on time. Thus, $h_i(t)=h_0(t)e^{\beta_1 + \beta_2 x_i(t)}$. We want to test whether $\beta_2 = 0$, which means that there are proportional hazards. This is done by the r function cox.zph. 

Additional work on what the cox.zph function does to test the hypothesis that $\beta_2=0$ will be explored by looking at the r documentation.  

The following plots display the survival function, hazard function (to be estimated by the cox model), and cumulative hazard function for the AIDS study. 

```{r, echo=FALSE}
KM <- survfit(Surv(time, censor)~1, data=aids)
KM_trt<- survfit(Surv(time, censor)~txgrp_text, type="kaplan-meier", conf.type="log", data=aids)
KM_karnof <- survfit(Surv(time, censor)~karnof, type="kaplan-meier", conf.type="log", data=aids)
KM_cd4f <- survfit(Surv(time, censor)~cd4f, type="kaplan-meier", conf.type="log", data=aids)

ggsurvplot(KM, conf.int=TRUE, censor=F) + ggtitle("Overall Survival Curve")
plot.haz(KM)
ggsurvplot(KM, fun="cumhaz") + ggtitle("Cumulative Hazard Curve")
```

The table below displays the significance of each covariate individually when incorporated into a model.

```{r, echo=FALSE}
covariates <- c("txgrp", "sex",  "raceth", "ivdrug", "hemophil", "karnof", "cd4", "priorzdv", "age")
univ_formulas <- sapply(covariates,
                        function(x) as.formula(paste('Surv(time, censor)~', x)))
univ_models <- lapply( univ_formulas, function(x){coxph(x, data = aids)})
# Extract data 
univ_results <- lapply(univ_models,
                       function(x){ 
                          x <- summary(x)
                          p.value<-signif(x$wald["pvalue"], digits=2)
                          wald.test<-signif(x$wald["test"], digits=2)
                          beta<-signif(x$coef[1], digits=2);#coeficient beta
                          HR <-signif(x$coef[2], digits=2);#exp(beta)
                          HR.confint.lower <- signif(x$conf.int[,"lower .95"], 2)
                          HR.confint.upper <- signif(x$conf.int[,"upper .95"],2)
                          HR <- paste0(HR, " (", 
                                       HR.confint.lower, "-", HR.confint.upper, ")")
                          res<-c(beta, HR, wald.test, p.value)
                          names(res)<-c("beta", "HR (95% CI for HR)", "wald.test", 
                                        "p.value")
                          return(res)
                          #return(exp(cbind(coef(x),confint(x))))
                         })
res <- t(as.data.frame(univ_results, check.names = FALSE))
as.data.frame(res)
```

The individual covariates txgrp, karnof, and cd4 have significant correlation coefficients. The order of covariates in order of most to least significant is karnof, cd4, txgrp, age, ivdrug, prior zdv, sex, hemophil and raceth. Now, to explore the proportional hazards assumption, I will plot the complimentary log log curves for the most significant variables. Under perfect proportional hazards, at any point in time, the difference between any two curves is constant. When proportional hazards is violated, the curves will exhibit a significant cross.

```{r, echo=FALSE}
p1 <- ggsurvplot(KM_trt, conf.int=TRUE, censor=F) 
p2 <- ggsurvplot(KM_trt, conf.int=TRUE, censor=F,  fun='cloglog')

p3 <- ggsurvplot(KM_karnof, conf.int=TRUE, censor=F)
p4 <- ggsurvplot(KM_karnof, conf.int=TRUE, censor=F, fun='cloglog')

p5 <- ggsurvplot(KM_cd4f, conf.int=TRUE, censor=F) 
p6 <- ggsurvplot(KM_cd4f, conf.int=TRUE, censor=F, fun='cloglog')

ggsurvlist1 <- list(p1, p2)
ggsurvlist2 <- list(p3, p4)
ggsurvlist3 <- list(p5, p6)

# Arrange multiple ggsurvplots and print the output

arrange_ggsurvplots(ggsurvlist1, print = TRUE, ncol = 2, nrow = 1, title = 'Treatment')
arrange_ggsurvplots(ggsurvlist2, print = TRUE, ncol = 2, nrow=1, title = 'Karnofsky')
arrange_ggsurvplots(ggsurvlist3, print = TRUE, ncol = 2, nrow=1, title = 'CD4')
```
When treatment is the variable, the complimentary log log curves clearly do not cross, indication proportional hazards. When karnofsky score is the variable, scores of 90 and 100 overlap a bit, but are essentially the same curve (and the confidence intervals are very large and overlapping), so proportional hazards holds. When CD4 is the variable, the curves for the higher categories have some overlap, but once again have extremely large and overlapping confidence intervals, so we can assume proportional hazards. A multivariate model will be fit with the three significant covariates in the order of most to least significant, as all appear to have proportional hazards. 

I will build a cox ph model using onlu txgrp as a covariate
```{r, echo=FALSE}
cox <- coxph(Surv(time,censor) ~ txgrp, data = aids)
cox %>% tidy()
pchisq((-2*cox$loglik[1])-(-2*cox$loglik[2]), d=1, lower.tail = FALSE)
```
The estimate for the treatment coefficient is -0.76225, which means that there is a reduction in hazard as treatment group changes from placebo to IDV. The LRT for adding in txgrp as a variable results in a p-value of 0.002, so it is included in the model. 

I will build a cox ph model using txgrp + karnof as the covariates. 
```{r, echo=FALSE}
cox1 <- coxph(Surv(time,censor) ~ txgrp + karnof, data = aids)
cox1 %>% tidy()
pchisq((-2*cox$loglik[2])-(-2*cox1$loglik[2]), d=1, lower.tail = FALSE)
```
The estimate for the karnofsky coefficient is -0.080462, so hazard decreases as karnosky score increases. The LRT for adding in karnof as a variable results in a p-value of 1.320752e-08, so it is included in the model.

I will build a cox ph model using txgrp + karnof + cd4 as the covariates. 
```{r, echo=FALSE}
cox2 <- coxph(Surv(time,censor) ~ txgrp + karnof + cd4, data = aids)
cox2 %>% tidy()
pchisq((-2*cox1$loglik[2])-(-2*cox2$loglik[2]), d=1, lower.tail = FALSE)
```
The estimate for the cd4 coefficient is -0.014622, so hazard decreases as cd4 increases. The LRT for adding in cd4 as a variable results in a p-value of 7.403133e-09, so it is included in the model. 

I will build a cox ph model using txgrp + karnof + cd4 + age as the covariates. 
```{r, echo = FALSE}
cox3 <- coxph(Surv(time,censor) ~ txgrp + karnof + cd4 + age, data = aids)
cox3 %>% tidy()
pchisq((-2*cox2$loglik[2])-(-2*cox3$loglik[2]), d=1, lower.tail = FALSE)
```
The confidence interval for the coefficient for age includes 0, so it is unclear what effect age has on hazard.The LRT for adding in age as a variable results in a p-value of .13, so it is not included in the model. The covariates txgrp, karnof and cd4 should be included in the model built using forward selection. Next, I will create a model where cd4 is split into factors to see if it shoud be a categorical or continuous variable. 

```{r, echo=FALSE}
cox4 <- coxph(Surv(time,censor) ~ txgrp + karnof + cd4f, data = aids)
cox4 %>% tidy()
pchisq((-2*cox1$loglik[2])-(-2*cox4$loglik[2]), d=6, lower.tail = FALSE)
```
The p-value of 2.559148e-06 shows that the cd4 categories should be included in the model.The log(HR) will be linear in cd4 if it should be linear. Thus, $\frac{e^{b_2}}{e^{b_1}}=\frac{e^{b_3}}{e^{b_2}}=\frac{e^{b_4}}{e^{b_3}}$, so $b_2-b_1=b_3-b_2=b_4-b_3$.  

```{r, echo=FALSE}
-1.89993881--2.39426985
-2.39426985--2.93830829
-2.93830829--0.31005778
```
Because there are constant 50 cd4 gaps between the groups. The relationship holds for the upper 3 cd4 factors, but the value from moving from the lowest to the next lowest cd4 group is -2.628251 as compared to around 0.5, so cd4 should be kept as factors. Next, I will create models with interaction: first with karnof and cd4f interacting, and then with txgrp and cd4 interacting. 

```{r, echo=FALSE}
cox5 <- coxph(Surv(time,censor) ~ txgrp + karnof*cd4f, data = aids)
cox5 %>% tidy()
pchisq((-2*cox4$loglik[2])-(-2*cox5$loglik[2]), d=6, lower.tail = FALSE)
```
The p-value of 0.2164783 indicates that interaction between karnof and cd4f is not necessary in the model. 

```{r, echo=FALSE}
cox6 <- coxph(Surv(time,censor) ~ txgrp*cd4f + karnof + cd4f, data = aids)
cox6 %>% tidy()
pchisq((-2*cox4$loglik[2])-(-2*cox6$loglik[2]), d=6, lower.tail = FALSE)
```
The p-value of 0.5398977 indicates that interaction between txgrp and cd4 is not needed in the model. 

The best candidate models are those with txgrp, karnof, and cd4 as either a categorical or continuous variable. 

Now, I will test whether the proportional hazards assumption holds with the two best models. 
```{r, echo=FALSE}
cox.zph(cox2)
cox.zph(cox4)
```
From the cox.zph test, the p-value for all covariates is above 0.05, so the proportional hazards assumption is met and we cannot reject the null hypothesis that the hazards ratio is dependent on time. 
